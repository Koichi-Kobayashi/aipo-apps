<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="リリース7"
            description="会社内でのリリース日共有のためのアプリです。">
        <Require feature="views"/>
        <Require feature="dynamic-height"/>
        <Require feature="minimessage"/>
        <Require feature="tabs"/>
        <Require feature="aipostyle"/>
        <Require feature="osapi"/>
        <Require feature="setprefs"/>
    </ModulePrefs>
    <UserPref name="p1-homeRows" display_name="表示件数（通常時）" datatype="enum" default_value="5">
        <EnumValue value="5"/>
        <EnumValue value="10"/>
        <EnumValue value="50"/>
    </UserPref>
    <UserPref name="p2-canvasRows" display_name="表示件数（最大化時）" datatype="enum" default_value="10">
        <EnumValue value="5"/>
        <EnumValue value="10"/>
        <EnumValue value="50"/>
    </UserPref>


    <Content type="html"><![CDATA[
        <div class="aipostyle">
            <form name="date">
                <table class="form wide">
                    <tbody>
                    <tr>
                        <th>リリース日</th>
                        <td>
                            <select id="yearid" name="yearname" onchange="daySet()">年</select>
                            <select id="monthid" name="monthname" onchange="daySet()">月</select>
                            <select id="dayid" name="dayname">日</select>
                        </td>
                        <th>タイトル</th>
                        <td><input type="text"
                                   id="commentid"/></td>
                        <th>担当者</th>
                        <td><input type="text"
                                   id="staffid"/></td>
                    </tr>
                    </tbody>
                </table>
                <div class="center">
                    <input type="button" value="投稿する" onclick="eventSubmit()"/>
                    <input type="button" value="データ一覧表示" onclick="datacheck()"/>
                </div>
            </form>

            <form name="schedules">
                <h3>リリーススケジュール</h3>
                <table class="list wide">
                    <thead id = "header">
                    </thead>
                    <tbody id="status">
                    </tbody>
                </table>
            <div id="pager" style="text-align:center;" class="pager"></div>
            </form>
        </div>

        <script type="text/javascript" src="https://d2hv4ldeur9lfv.cloudfront.net/opensocial-jquery-1.3.2.5.min.js">
        </script>
        <script type="text/javascript">

            //変数設定
                //日時に関する変数
                var dateToday = new Date();
                var yearToday = dateToday.getYear();
                var yearCEToday = (yearToday<2000) ? yearToday+1900 : yearToday ;
                var monthToday = dateToday.getMonth() + 1;
                var dayToday = dateToday.getDate();
                var yearMonthDayToday = yearCEToday*10000 + monthToday*100 + dayToday;
                var msg = new gadgets.MiniMessage();
                var max_per_page = getPrefRows();
                var prefs = new gadgets.Prefs();

            //セレクトボックスを今年の1/1に初期化
            function initSelectbox(){
                //あとでセレクトボックスに挿入するHTML
                var yearHtml = new Array();
                var monthHtml = new Array();
                //yearHtmlに現在から10年後までを代入
                for (var i=yearCEToday ; i<=yearCEToday+10 ; i++){
                    yearHtml.push('<option value="' + i + '">' + i + '</option>');
                }

                //monthHtmlに1から12を代入
                for (var i=1 ; i<=12 ; i++){
                    monthHtml.push('<option value="' + i + '">' + i + '</option>');
                }

                document.getElementById("yearid").innerHTML = yearHtml;
                document.getElementById("monthid").innerHTML = monthHtml;
                daySet();
            }

            //年月から日数を計算してセレクトボックスへ挿入
            function daySet(){
                //あとでセレクトボックスに挿入するHTML
                var dayHtml = new Array();
                //月ごとの日数を計算して入れておく変数
                var daysOfMonth;
                //現在セレクトボックスで選択されている年月
                var yearSelectedNow = document.date.yearname.selectedIndex + yearCEToday;
                var monthSelectedNow = document.date.monthname.selectedIndex + 1;

                //月毎の日数を計算
                if (monthSelectedNow == 4 || monthSelectedNow == 6 || monthSelectedNow == 9 || monthSelectedNow == 11){
                    daysOfMonth = 30;
                }else if(monthSelectedNow != 2){
                    daysOfMonth = 31;
                }else{
                    daysOfMonth = daysOfFeb(yearSelectedNow);
                }

                //dayHtmlに、選択された年と月に合わせた日数を代入
                for (var i=1 ; i <= daysOfMonth ; i++){
                    dayHtml.push('<option value="' + i + '">' + i + '</option>');
                }

                document.getElementById("dayid").innerHTML = dayHtml;

            }

            //2月の日数を求める関数
            function daysOfFeb(year){
                if (year%4 == 0){
                    if (year%100 ==0){
                        return(29);
                    }else{
                    return(28);
                    }
                }else{
                return(29);
                }
            }

            //入力されたデータを保存する関数（飲みイコ）
            function eventSubmit() {
                //フォームからの値の取得
                var yearSubmitted = $("#yearid").val() ;
                var monthSubmitted = $("#monthid").val();
                var daySubmitted = $("#dayid").val();
                var commentSubmitted = $("#commentid").val();
                var staffSubmitted = $("#staffid").val();

                //ソート用に文字列状態の数字をint型に変換
                var intYearSubmitted =parseInt(yearSubmitted);
                var intMonthSubmitted =parseInt(monthSubmitted);
                var intDaySubmitted =parseInt(daySubmitted);
                var intYearMonthDaySubmitted = intYearSubmitted*10000 + intMonthSubmitted*100 + intDaySubmitted;

                //データ保存用の年月日
                var savedYearMonthDay = yearSubmitted + "年" + monthSubmitted + "月" + daySubmitted + "日";

                //今回入力されたデータを入れておく配列
                var allScheduleDataSaved = {};

                //バリデート
                if (!commentSubmitted || commentSubmitted.length > 100 || !staffSubmitted || staffSubmitted.length > 100){
                    if (!commentSubmitted) {
                        msg.createTimerMessage("コメントを入力してください。", 5);
                        gadgets.window.adjustHeight();
                    }
                    if (commentSubmitted.length > 100) {
                        msg.createTimerMessage("コメントは100文字までで入力してください。", 5);
                        gadgets.window.adjustHeight();
                    }
                    if (!staffSubmitted) {
                        msg.createTimerMessage("担当者を入力してください。", 5);
                        gadgets.window.adjustHeight();
                    }
                    if (staffSubmitted.length > 100) {
                        msg.createTimerMessage("担当者は100文字までで入力してください。", 5);
                        gadgets.window.adjustHeight();
                    }
                    return false;
                }

            var timestamp = new Date().getTime();
            var key = '__MODULE_ID__.' + timestamp;
            var date = timestamp + "";

            osapi.appdata.get({ userId: ["@viewer"] ,fields: ['keys'] }).execute(function(response) {
                for (var userId in response) {
                    var tmp_data = response[userId];
                }
                var keys = new Array();
                if (tmp_data && tmp_data['keys']) {
                    keys = gadgets.json.parse(tmp_data['keys']);
                }

                keys.push(key);

                var data = {};
                var data1 = {};
                var data2 = {};
                data['date'] = gadgets.util.escapeString(date);
                data['yearMonthDay'] = gadgets.util.escapeString(savedYearMonthDay);
                data['intYearMonthDay'] = gadgets.util.escapeString(intYearMonthDaySubmitted);
                data['comment'] = gadgets.util.escapeString(commentSubmitted);
                data['staff'] = gadgets.util.escapeString(staffSubmitted);
                data1[key] = gadgets.json.stringify(data);
                data2['keys'] = gadgets.json.stringify(keys);

                var batch = osapi.newBatch()
                        .add('update1', osapi.appdata.update({ userId: '@viewer', data: data1, appId: '@app' }))
                        .add('update2', osapi.appdata.update({ userId: '@viewer', data: data2, appId: '@app' }));
                batch.execute(function(response) {
                    $("#commentid").val("");
                    $("#staffid").val("");
                    // minimessage
                    msg.createTimerMessage("送信しました。", 3, function() {
                        gadgets.window.adjustHeight();
                        return true;
                    });
                    // データの再表示
                   repaint();
                });
            });
        }

            //テーブルの再描画関数
            function repaint() {
                osapi.people.get({ userId: '@viewer' }).execute(function(response) {
                    var users = [];
                    var userIds = [];
                    var row_datas = [];
                    var keys = [];
                    var counter = 0;

                    // ユーザーID
                    var currentUserid = response.id;

                    // ユーザーの読み込み
                    osapi.people.get({ userId: '@viewer', groupId: '@all', startIndex: 0, count: 200}).execute(function(response) {

                        var list = response.list;
                        for (var i in list) {
                            users[list[i].id] = list[i];
                            userIds.push(list[i].id);
                        }
                        // データの取得
                        osapi.appdata.get({ userId: userIds ,fields: ['keys'] }).execute(function(response) {
                            // 全てのkeyを取得して配列keysに入れる
                            for (var userId in response) {
                                var tmp_keys = gadgets.json.parse(response[userId]['keys']);
                                for (var tmp_key in tmp_keys) {
                                    keys.push(tmp_keys[tmp_key]);
                                }
                            }
                                    // 配列keysの中身をkeyとして使ってアプリデータを取得
                                    osapi.appdata.get({ userId: userIds ,fields: keys }).execute(function(response) {
                                        for (var userId2 in response) {
                                            var data = response[userId2];

                                            for (var key in data) {
                                                // データの作成
                                                var rowdata = gadgets.json.parse(data[key]);
                                                rowdata["key"] = key;
                                                row_datas.push(rowdata);
                                            }
                                        }

                                        // 日付降順
                                        row_datas.sort(function(a, b) {
                                            return a["intYearMonthDay"] < b["intYearMonthDay"] ? 1 : -1;
                                        });

                                        // テーブルヘッダー
                                        if (row_datas.length > 0) {
                                            $("#header").html("");
                                            var header = '\
                                                 <tr>\
                                                 <th>リリース日</th>\
                                                 <th>内容</th>\
                                                 <th>担当者</th>\
                                                 <th class="thin">削除</th>\
                                                 </tr>\
                                                  ';
                                            $("#header").html($("#header").html() + header);
                                        }
                                        if (row_datas.length > max_per_page) {
                                            var pager = '<a href="javascript:void(0);" onclick="showMore();">全件表示</a>';
                                            $("#pager").html(pager);
                                            $("#pager").show();
                                        }

                                            $("#status").html("");
                                        for (var i in row_datas) {
                                            var css_class = '';
                                            if (counter % 2 == 0) {
                                                css_class = ' class="odd"';
                                            }
                                            if (counter >= max_per_page) {
                                                css_class += ' style="display:none;"';
                                            }
                                            counter++;
                                            var delete_html = '';

                                            var key_data = '\
                                                   <tr' + css_class + '>\
                                                   <td>' + gadgets.util.escapeString(row_datas[i]["yearMonthDay"]) + '</td>\
                                                   <td>' + gadgets.util.escapeString(row_datas[i]["comment"]) + '</td>\
                                                   <td>' + gadgets.util.escapeString(row_datas[i]["staff"]) + '</td>\
                                                   <td>' + delete_html + '</td>\
                                                   </tr>\
                                                   ';
                                            // データの表示
                                            $("#status").html($("#status").html() + key_data);
                                        }
                                        // ウインドウの幅再調整
                                        gadgets.window.adjustHeight();
                                    });
                        });
                    });
                });
            }


            function datacheck(){ //Aipo公式のまね
                osapi.appdata.get({ userId: '@viewer' ,fields: 'keys' }).execute(function(response) {
                // ユーザーID、アプリデータの連想配列
                    for (var userId in response) {
                       var data = response[userId];
                       // キー, 値の連想配列
                       for (var key in data) {
                          // 値
                          // 例）値1
                          var value = data[key];
                          alert(value);
                       }
                    }
                });
            }

        /*
         * 設定の読み込み
         */
        function getPrefRows() {
            // 設定の読み込み
            var currentView = gadgets.views.getCurrentView();
            if (currentView.getName() == "home") {
                return parseInt("p1-homeRows");
            } else {
                return parseInt("p2-canvasRows");
            }
        }

            //初期化
            function init() {
                initSelectbox();
                repaint();
                gadgets.window.adjustHeight();
            }

        gadgets.util.registerOnLoadHandler(init);
        </script>
    ]]></Content>


</Module>
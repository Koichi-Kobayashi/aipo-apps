<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="東京電力電力利用状況"
            description="東京電力電力利用状況を表示するアプリです。">
        <Require feature="aipostyle"/>
        <Require feature="dynamic-height" />
    </ModulePrefs>
    <Content type="html"><![CDATA[
<script src="https://d2hv4ldeur9lfv.cloudfront.net/opensocial-jquery-1.3.2.5.min.js"></script>

<script>
  
  $(init);
  
  function init() {
    update();
  }
  
  function update() {
    jQuery.getJSON(
      "https://tepco-usage-api.appspot.com/latest.json?callback=?", 
      function (data) {
        var date = data.year + '年' + data.month + '月' + data.day + '日 ' + data.hour + '時現在';
        $('#date').html(date);

        var capacity = data.capacity;
        var usage = data.usage;
        $('#capacity').html(capacity + '万kW');
        $('#usage').html(usage + '万kW');
        
        var usageRate = Math.round(usage/capacity*100);
        $('#usageRate').html(usageRate + '%');
        for (var i = 10; i <= 100; i += 10) {
          if (i > usageRate) {
            $('#usageRate' + i).hide();
          } else {
            $('#usageRate' + i).show();
          }
        }
        var timer = setInterval(update, 10*60*1000);
      }
    );
  }
</script>

<style>
th , td { white-space: nowrap; font-weight: bold; }
#usageRate { color:red; }
.usageSafe { color:lightgreen; }
.usageWarn { color:orange; }
.usageDanger { color:red; }
</style>

</head>
<body>
<div class="aipostyle">
<table class="form wide">
    <tr>
        <th>日時</td>
        <th id="date"></td>
    </tr>
    <tr>
        <th>消費率</td>
        <td>
          <span id="usageRate"></span>
          <span class="usageSafe" id="usageRate10">■</span>
          <span class="usageSafe" id="usageRate20">■</span>
          <span class="usageSafe" id="usageRate30">■</span>
          <span class="usageSafe" id="usageRate40">■</span>
          <span class="usageSafe" id="usageRate50">■</span>
          <span class="usageSafe" id="usageRate60">■</span>
          <span class="usageWarn" id="usageRate70">■</span>
          <span class="usageWarn" id="usageRate80">■</span>
          <span class="usageDanger" id="usageRate90">■</span>
          <span class="usageDanger" id="usageRate100">■</span>
        </td>
    </tr>
    <tr>
        <th>供給可能最大電力</td>  
        <td id="capacity"></td>  
    </tr>
    <tr>
        <th>現在の消費電力</td>  
        <td id="usage"></td>  
    </tr>
</table>
</div>

<script type="text/javascript">

function init() {
  gadgets.window.adjustHeight();
}
gadgets.util.registerOnLoadHandler(init);
</script>
        ]]></Content>
</Module>